name: Version Management

on:
  pull_request:
    types: [closed]
    branches: [develop, main]

jobs:
  version-develop:
    if: github.event.pull_request.merged == true && github.base_ref == 'develop'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Increment dev version
        run: |
          # Read current version
          CURRENT=$(cat VERSION | tr -d '\n')
          echo "Current version: $CURRENT"

          # Check if it's already a dev version
          if [[ $CURRENT == *"-dev."* ]]; then
            # Increment dev number
            BASE=$(echo $CURRENT | sed 's/-dev\.[0-9]*//')
            DEV_NUM=$(echo $CURRENT | grep -oP '(?<=-dev\.)\d+')
            NEW_DEV=$((DEV_NUM + 1))
            NEW_VERSION="${BASE}-dev.${NEW_DEV}"
          else
            # First dev build after release
            NEW_VERSION="${CURRENT}-dev.1"
          fi

          echo "New version: $NEW_VERSION"
          echo "$NEW_VERSION" > VERSION

          # Commit and push
          git add VERSION
          git commit -m "chore: Bump version to ${NEW_VERSION} [skip ci]"
          git push origin develop

      - name: Summary
        run: |
          echo "## ðŸ“¦ Version Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **New version**: $(cat VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY

  version-main:
    if: github.event.pull_request.merged == true && github.base_ref == 'main' && github.head_ref == 'develop'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create release tag
        run: |
          # Read version (should already be clean, e.g., "1.0.0")
          VERSION=$(cat VERSION | tr -d '\n')
          echo "Version: $VERSION"

          # Create annotated tag
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"

          echo "Created tag v${VERSION}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes "## Release v${VERSION}

          Promoted from develop branch.

          See the [changelog](../../compare/v${VERSION}...develop) for details."

      - name: Summary
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          echo "## ðŸŽ‰ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release**: Created" >> $GITHUB_STEP_SUMMARY
